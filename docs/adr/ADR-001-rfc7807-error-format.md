# ADR-001: RFC 7807 Error Format
Дата: 2025-10-22

Статус: Accepted

## Context
Workout Log API (FastAPI + SQLAlchemy) возвращает ошибки в разных форматах: стандартные FastAPI ошибки валидации и кастомные HTTPException. Это создает проблемы консистентности для мобильных клиентов и риски безопасности.

## Decision
Реализовать глобальный обработчик ошибок по стандарту RFC 7807 для всего Workout Log API с генерацией correlation_id.

## Alternatives Considered
1. **Стандартные ошибки FastAPI**
   - Плюсы: Простая реализация, встроенная поддержка фреймворком
   - Минусы: Нестандартный формат, нет correlation_id, раскрытие внутренней структуры

2. **Кастомный JSON формат**
   - Плюсы: Полный контроль над структурой, адаптация под нужды
   - Минусы: Нестандартный подход, сложность поддержки, клиенты изучают новый формат

3. **RFC 7807 (выбранный вариант)**
   - Плюсы: Стандартизированный подход (IETF), correlation_id, широкая поддержка инструментов
   - Минусы: Дополнительная сложность реализации, миграция клиентов

## Decision Rationale
Выбран RFC 7807 потому что:
- **Стандартизация** перевешивает простоту FastAPI ошибок - клиенты получают единый формат
- **Correlation ID** критически важен для трассировки в production
- **Безопасность** (отсутствие stack trace) приоритетнее простоты реализации
- **Компромисс**: принимаем дополнительную сложность ради стандартизации и безопасности

## Security Impact
- **Устранение риска R8**: Небезопасные ошибки API (из Threat Model P04)
- **Соответствие NFR-08**: Безопасные ошибки без stack trace (из P03)
- **Улучшение аудита**: correlation_id позволяет трассировать инциденты
- **KPI**: 0% ответов с stack trace в production

## Rollout Plan
### Definition of Done
- [ ] Реализован глобальный exception handler в FastAPI
- [ ] Все эндпоинты (/workouts, /exercises, /stats) возвращают RFC 7807 ошибки
- [ ] Добавлены тесты для проверки формата ошибок
- [ ] correlation_id включен в логи приложения
- [ ] Документация обновлена с примерами ошибок

### План внедрения
- **Фаза 1 (Dev)**: Реализация обработчика + unit тесты
- **Фаза 2 (Staging)**: Пилотное тестирование с feature-flag для 10% трафика
- **Фаза 3 (Production)**: Canary rollout: 25% → 50% → 100% трафика с мониторингом ошибок

## Consequences
- **Плюсы:** Стандартизированный формат, улучшенная трассировка, безопасность ошибок
- **Минусы:** Дополнительная сложность реализации

## Links
- NFR-08 (безопасные ошибки)
- R8 (небезопасные ошибки API)
- tests/test_error_handling.py::test_rfc7807_format
