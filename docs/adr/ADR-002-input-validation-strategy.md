# ADR-002: Input Validation Strategy
Дата: 2025-10-22

Статус: Accepted

## Context
Workout Log API обрабатывает пользовательские данные (тренировки, упражнения) через FastAPI эндпоинты. Необходима защита от XSS, SQL injection и невалидных данных.

## Decision
Использовать Pydantic V2 с field_validator для комплексной валидации и HTML санитизации всех схем данных Workout Log.

## Alternatives Considered
1. **Ручная валидация в эндпоинтах**
   - Плюсы: Полный контроль, гибкость
   - Минусы: Дублирование кода, сложность поддержки, пропущенные проверки

2. **Сторонние библиотеки валидации**
   - Плюсы: Готовые решения, расширенный функционал
   - Минусы: Дополнительные зависимости, совместимость с FastAPI

3. **Pydantic V2 (выбранный вариант)**
   - Плюсы: Интеграция с FastAPI, типобезопасность, производительность
   - Минусы: Ограниченная кастомизация, зависимость от схем

## Decision Rationale
Выбран Pydantic V2 потому что:
- **Интеграция с FastAPI** обеспечивает seamless валидацию на уровне фреймворка
- **Типобезопасность** предотвращает целые классы ошибок на этапе компиляции
- **Производительность** Pydantic выше ручных проверок
- **Компромисс**: принимаем зависимость от схем ради надежности и производительности

## Security Impact
- **Устранение риска R12**: Невалидация входных данных (из Threat Model P04)
- **Соответствие NFR-08**: Валидация данных (из P03)
- **Защита от XSS**: HTML санитизация для полей name и note
- **KPI**: 100% покрытие тестами граничных значений

## Rollout Plan
### Definition of Done
- [x] Все Pydantic схемы имеют field_validator для санитизации
- [x] Тесты покрывают граничные значения и инъекции
- [x] Валидация веса (0.1-500kg) и повторений (1-100)
- [x] HTML экранирование для текстовых полей

### План внедрения
- **Фаза 1 (Dev)**: Добавление валидаторов к существующим схемам
- **Фаза 2 (Staging)**: Пилотное тестирование с мониторингом валидационных ошибок
- **Фаза 3 (Production)**: Постепенное включение с feature-flag для новых эндпоинтов

## Consequences
- **Плюсы:** Защита от XSS, стандартизированная валидация, типобезопасность
- **Минусы:** Усложнение схем данных, зависимость от Pydantic

## Links
- NFR-08 (валидация данных)
- R12 (невалидация входных данных)
- tests/test_validation_security.py
